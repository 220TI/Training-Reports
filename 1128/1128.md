- [OSPF](#ospf)
  - [有効化](#有効化)
  - [ネイバー/アジャセンシー](#ネイバーアジャセンシー)
  - [ルータID](#ルータid)
  - [プライオリティ](#プライオリティ)
  - [DR/BDR](#drbdr)
  - [ルータのタイプ](#ルータのタイプ)
  - [エリア](#エリア)
  - [ステート](#ステート)
  - [LSA (Link State Advertisement)](#lsa-link-state-advertisement)
    - [LSAタイプ](#lsaタイプ)
  - [LSU (Link State Update)](#lsu-link-state-update)
  - [LSDB (Link State Database)](#lsdb-link-state-database)
  - [ネットワークタイプ](#ネットワークタイプ)
  - [ネイバーと一致させる情報](#ネイバーと一致させる情報)
  - [経路集約](#経路集約)
  - [等コストロードバランス](#等コストロードバランス)
  - [確認コマンド](#確認コマンド)
  - [prefix](#prefix)



# OSPF
OSPFはリンクステート型のプロトコルであり、ルータ同士のリンク情報を集めて効率的なルーティングを実現する。ダイクストラアルゴリズム（Shortest Path First: SPFアルゴリズムとも呼ばれる）により、高速な収束を実現している。

## 有効化

```
RT1(config)#router ospf {PID}
RT1(config-router)#network 10.0.0.0 0.0.0.3 area 0 // 有効にしたいIFの"ネットワーク"アドレス
```

IFコンフィギュレーションモードからも有効化することができる。

```
RT1(config-if)#ip ospf {PID} area {areaID}
```

## ネイバー/アジャセンシー

ネイバー:Helloパケットを交換することで互いに認識したルータ。ネイバーは同じネットワークセグメントに存在し、OSPFのHelloパケットをやり取りすることでネイバー関係が確立される。

アジャセンシー (Adjacency): ネイバー関係からさらに進んで、ルータ同士がルーティング情報を交換する関係。アジャセンシーはネイバーの一部であり、必ずしも全てのネイバーがアジャセンシーを形成するわけではない。例えば、ブロードキャストマルチアクセスネットワークでは、DRおよびBDRのみが他のルータとアジャセンシーを形成し、他のネイバーはDR/BDRとのみ完全な隣接関係を持つ。

## ルータID
  - コマンドで明示的に設定したID `router-id {ID}` コマンドで指定可能。ルータIDはOSPFネットワーク内で一意である必要がある。
  - ループバックインターフェース ルータIDが設定されていない場合、ループバックインターフェースのIPアドレスがルータIDとして使用される。
  - UPインターフェースの中で最大のIPアドレス ループバックがない場合は、UP状態のインターフェースの中で最大のIPアドレスがルータIDに選ばれる。

## プライオリティ
  - OSPFのDR/BDR選出時に使用される値。プライオリティが高いルータがDRとして選出される。
  - 起動順序により決定され、OSPFプロセスを再起動するまで適用されない。
  - プライオリティ値を0に設定することで、そのルータをDR/BDRの選出対象外にすることも可能。
  
## DR/BDR
  - DR (Designated Router) は、ブロードキャストおよびNBMAネットワークにおいて、ネットワーク上の全ルータからのリンクステート情報を集約する役割を持つ。
  - BDR (Backup Designated Router) はDRのバックアップとして動作し、DRがダウンした場合に代わりを務める。
  - DR/BDRの選出はプライオリティ値とルータIDに基づいて行われる。

## ルータのタイプ
  - 内部ルータ (Internal Router) :全てのインターフェースが同じエリアに属するルータ。
  - バックボーンルータ (Backbone Router) :少なくとも1つのインターフェースがバックボーンエリア(Area 0)に属するルータ。
  - ABR (Area Border Router) :複数のエリアに接続し、エリア間のルートを集約・交換するルータ。ABRはエリア0に接続している必要がある。
  - ASBR (Autonomous System Boundary Router) :OSPF外部の他のASからのルートを持ち込み、OSPF内に配布するルータ。

## エリア
  - 最低でもArea 0を持つ。 Area 0はOSPFのバックボーンエリアとして、全ての他エリアと接続する必要がある。
  - スタブエリア :外部ASからのルートを受け取らないエリアであり、そのためエリア内部のルーティング情報のみを保持する。これにより、エリア内のルーティングテーブルを小さく保つことができ、ルータのリソース使用を抑えることがでる。スタブ（stub）とは“行き止まり”を意味する。
  - NSSA (Not-So-Stubby Area) :スタブエリアの機能を持ちながら、ASBRを持ち、外部ルートの一部を持つことができるエリア。

マルチエリアOSPFにすることで、他エリアのルーティング情報の集約が可能となる。集約することによりルーティングテーブルのサイズが小さくなり、ルーティングにおけるオーバーヘッドが減少する。また障害が発生した場合でも、障害発生時のSPF計算はエリアごとに行われるため影響を1つのエリア内だけに留めることができるので、コンバージェンスも早くなる。

## ステート
  - DOWN :ネイバー関係がまだ確立されていない状態。Helloパケットを受信していない最初の状態。
  - INIT :Helloパケットを受信し、相手を認識した状態。
  - 2WAY :双方向のHelloパケットが確認され、ネイバー関係が確立された状態。DROTHER同士は経路情報を直接交換しないため、この状態でコンバージェンス。
  - EXSTART :データベース記述パケットの交換準備段階。DR、BDR決定（選出）済み。
  - EXCHANGE :データベース記述パケットの交換中。
  - LOADING :要求されたLSAの取得中。
  - FULL :ネイバー間でリンクステートデータベースが完全に同期された状態。最適経路の計算が完了した状態。

## LSA (Link State Advertisement) 

OSPFがリンクの状態を広告するためのメッセージ。

### LSAタイプ
  - ルータリンク (Type 1) :ルータが接続している全てのリンクを広告。
  - ネットワークリンク (Type 2) :DRがType1を受けて、ネットワーク上のルータ情報を広告。
  - 集約リンク (Type 3) :ABRが他エリアのネットワーク情報を集約して広告。
  - ASBR集約リンク (Type 4) :ASBRの存在を他のエリアに知らせるための広告。
  - AS外部リンク (Type 5) :OSPF外のASからの外部ルート情報を広告。NSSAでは流れない。
  - NSSAリンク (Type 7) :NSSAエリア内のASBRからの外部ルート情報を広告。

| タイプ | LSA名         | コード | 生成ルータ       | フラッディングされるエリア               | 概要                                  |
|--------|---------------|---------|-----------------|-----------------------------------------|---------------------------------------|
| 1      | ルータリンク   | O       | 全ルータ         | 生成エリア内                             | 同じエリアにいるルータのリンク情報    |
| 2      | ネットワークリンク | O       | DR              | 生成エリア内                             | 同じエリアにいるルータの一覧情報      |
| 3      | 集約リンク     | O IA    | ABR             | 標準エリア、バックボーンエリア、スタブエリア | 他のエリアへの経路情報                |
| 4      | ASBR集約リンク | O IA    | ABR             | 標準エリア、バックボーンエリア           | ASBRへの経路情報                      |
| 5      | AS外部リンク   | O E1, E2 | ASBR            | 標準エリア、バックボーンエリア           | 外部AS（OSPF外）の経路情報           |
| 7      | NSSAリンク     | O N1, N2 | NSSA内のASBR    | NSSAエリア                              | NSSAのみにフラッディングされる外部AS（OSPF外）への経路情報 |


## LSU (Link State Update) 
LSAの情報を隣接ルータに伝達するためのパケット。

ルータ等が無いネットワークのIFからLSUを送信する必要はないので、`(config-router)# passive-interface {interface}`で抑制する。

## LSDB (Link State Database) 
OSPFルータがネットワーク全体のリンク状態情報を保持するデータベース。全てのOSPFルータは同じLSDBを持つ。OSPFでは30分ごとにLSDBを同期させる。

## ネットワークタイプ
  - ブロードキャストマルチアクセス :イーサネットのように、複数のルータが同じネットワークを共有する環境。
  - ノンブロードキャストマルチアクセス (NBMA) :フレームリレーやATMのように、ブロードキャストがサポートされないが、複数のルータが同じネットワークに接続する環境。
  - ポイントツーポイント :2つのルータが直接接続されている環境。
  - ポイントツーマルチポイント :1つのルータが複数のルータとポイントツーポイントで接続されている環境。

  接続しているネットワークのタイプによって、DR/BDRを選出する必要性の有無や適切なHello間隔などが異なる。そのため、インターフェースコンフィグレーションモードでネットワークタイプを指定することで、Hello間隔などが変更される。


 ## ネイバーと一致させる情報 
 OSPFネイバーになるためには、以下の情報が一致している必要がある。
  - エリアID
  - タイマー（HelloタイマーとDeadタイマー）
  - ネットワークマスク
  - 認証情報（必要な場合）
  - ネットワークタイプ

## 経路集約 
複数のルートを1つにまとめることにより、ルーティングテーブルのサイズを小さくする。OSPFではABRやASBRを使用して経路集約を行うことができる。これにより、ルーティングテーブルのエントリ数を減らし、ネットワークの効率を向上させることができる。

## 等コストロードバランス
 OSPFはデフォルトで等コストロードバランスをサポートし、複数の経路を同時に使用してトラフィックを分散させることができる。等コストロードバランスで使用する最大の経路数はデフォルトで4であり、この値は変更可能である。

## 確認コマンド
  - `show ip ospf` : OSPFプロセスの概要情報を確認する。
  - `show ip ospf neighbor` : OSPFネイバーの状態を確認する。
  - `show ip ospf database` : LSDB（リンクステートデータベース）の内容を確認する。
  - `show ip ospf interface` : 各インターフェースにおけるOSPFの詳細情報を確認する。


## prefix
配布するルートをフィルタリングできる。
例えば、特定のネットワークのみを配布する場合や、不要なネットワークを配布しないようにする際に利用する。フィルタリングは、アクセスリストやルートマップを使用して実現することができる。
~~~
RB(config)#ip prefix-list R1-filter seq 5 deny 192.168.10.0/24
RB(config)#ip prefix-list R1-filter seq 10 permit 0.0.0.0/0 le 32 //全てのネットワーク
RB(config)#router ospf 1
RB(config-router)#distribute-list prefix R1-filter in
~~~