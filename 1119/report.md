# 1118～1119

## 現場スキルキャッチアップ
memo: VSCodeにて、`Ctrl+K` ⇒ `V`を押下するとプレビューが表示される。

･  [WLAN](#wlan)
- [WLANの規格](#WLANの規格)
- [WLANの主な機能](#WLANの主な機能)
- [電波干渉](#電波干渉)
- [APのアンテナ](#APのアンテナ)
- [EIRP](#EIRP)
- [SNR](#SNR)
- [カバレッジの調節](#カバレッジの調節)
- [APのモード](#APのモード)
- [WLANアーキテクチャ](#WLANアーキテクチャ)
- [CAPWAP](#CAPWAP)
- [ローミング](#ローミング)
- [WLCの冗長化](#WLCの冗長化)
- [認証と暗号化](#認証と暗号化)
- [WLC初期設定](#WLC初期設定)

・ [問題解決の手法](#問題解決の手法)
- [ping](#ping)
- [拡張ping](#拡張ping)
- [traceroute](#traceroute)
- [デバッグ](#デバッグ)
- [loggingsynchronous](#loggingsynchronous)

### WLAN

#### WLANの規格

| 規格      | 周波数帯     | 最大速度            | 特徴                                         |
|-----------|--------------|--------------------|--------------------------------------------|
| 802.11a   | 5GHz         | 54 Mbps            | 干渉が少ないが、屋内での範囲が限定的       |
| 802.11b   | 2.4GHz       | 11 Mbps            | 干渉が多いが、広範囲で利用可能             |
| 802.11g   | 2.4GHz       | 54 Mbps            | 802.11bとの互換性があり、干渉も多い         |
| 802.11n(Wi-Fi 4)   | 2.4/5GHz     | 600 Mbps           | MIMO技術により速度と範囲が向上             |
| 802.11ac(Wi-Fi 5)  | 5GHz         | 6.93 Gbps          | チャネルボンディングとMU-MIMOをサポート    |
| 802.11ax(Wi-Fi 6)  | 2.4/5GHz     | 9.6 Gbps           | OFDMAとMU-MIMOにより効率が大幅に向上       |

#### WLANの主な機能

- チャネルボンディング:複数のチャネルを結合して帯域幅を広げ、より高速なデータ転送を実現する技術。

- QAM（Quadrature Amplitude Modulation）:複数の信号を組み合わせてデータ転送速度を向上させる変調方式。

- OFDMA（Orthogonal Frequency Division Multiple Access）:周波数を細分化し、複数のデバイスに同時にリソースを割り当てる。

- MIMO（Multiple Input Multiple Output）:複数の送信アンテナと受信アンテナを使用してデータ転送のスループットと信頼性を向上させる技術。

- ビームフォーミング（Beamforming）：特定の方向に信号を集中させることで、通信範囲と品質を向上させる技術。
 
#### 電波干渉

##### DFS(Dynamic Frequency Selection)
5GHz帯域でレーダーと干渉しないようチャネルを動的に選択する仕組み。
5GHz帯は以下のようにUNII（Unlicensed National Information Infrastructure）で分類され、レーダーと共有となっている。
 - UNII1（W52）
 - UNII2(W53)

 上記2つは一部事由を除き屋外利用禁止

 - UNII3(W56)
DFSにより屋外利用可能

参考:[無線LANの屋外利用について](https://www.tele.soumu.go.jp/j/sys/others/wlan_outdoor/)

##### DCA（Dynamic Channel Assignment）
AP間でのチャネルオーバーラップを避けるため、チャネルを動的に割り当てる。

#### APのアンテナ

##### 指向性アンテナ
 
- 八木アンテナ:高利得で、特定の方向に強い信号を送信することができる。よく屋上で見かけるこのような形。⇒ <---

- パッチアンテナ:平面上で、比較的広いエリアに信号を送信することができる。

##### 全方向性アンテナ（オムニアンテナ）
- ダイポールアンテナ:全方向に均等に信号を送信する。

#### EIRP
（Effective Isotropic Radiated Power）

送信電波の強さを示す値。アンテナ利得と送信機の出力を組み合わせた効果的な出力。

#### SNR
（Signal-to-Noise Ratio）

無線通信において信号の品質を示す。
RSSI（Received Signal Strength Indicator：受信信号強度）からNoiseを引いた値。

- データ通信:SNRが高いほど誤りが少なく、高速なデータ転送が可能になる。SNRが低いとデータパケットの再送が増え、通信速度が低下する。データ通信においては20dB以上が推奨される。

- 音声通信：SNRが低いと音質が悪化し、雑音が増えるため、安定した音声通信を実現するためには十分なSNRが必要。音声は遅延に敏感なため、安定したSNRが高品質な音声通話に不可欠。音声通信においては25dB以上が推奨される。

#### カバレッジの調節

- 最小データレート：APの最小データレート設定を高くすると、通信可能な距離が短くなり、カバレッジが小さくなる。低いデータレートを許可すると、より遠くのクライアントも接続可能となり、カバレッジが広がる。

- トランスミッタパワー：トランスミッタパワーを増加させると、電波がより遠くに届くため、APのカバレッジエリアが広がる。逆にトランスミッタパワーを減少させると、カバレッジエリアが狭くなる。

#### APのモード
| モード               | 概要                                                             |
|--------------------|-----------------------------------------------------------------|
| Local               | 通常のモード。クライアントの接続を監視するのに適している。                                      |
| FlexConnect (Hybrid REAP) | WAN経由でWLCと接続する場合のモード。WLCとの接続が切断された場合でも対応可能。 |
| Monitor          | 不正なAPの検出、および侵入検知用の**専用**センサーとして動作するモード。                         |
| Rogue Detector   | 有線ネットワーク上で不正なAPやクライアントを検出するモード。                             |
| Sniffer          | 特定チャンネル上のすべてのパケットを収集し、指定デバイスに送信するモード。         |
| Bridge           | APをブリッジとして動作させるモード。遠離の隣接APの中継が可能。                         |
| SE-Connect       | スペクトラムアナライザ用モード。ワイヤレストラブルなものや通信障害を調べるために使用。 |
| Sensor           | リアルタイムでネットワーク内のクライアント接続性に関する問題を解決するモード。APではなく無線LANクライアントとして機能する。専用センサーデバイスが必要。 |

Monitorモードが、”不正なAPの検出を行う**専用**センサーとして動作するモード”として出題されることに注意。

#### WLANアーキテクチャ

##### WLANクライアントの接続プロセス
1. ビーコン受信: クライアントはAPが定期的に送信するビーコンフレームを受信し、利用可能なSSIDやAPの情報を取得する。

2. プローブリクエスト: クライアントは、接続可能なAPを特定するためにプローブリクエストを送信する。このリクエストにはクライアントが接続を希望するSSIDが含まれる。

3. プローブレスポンス: APはクライアントからのプローブリクエストに対し、プローブレスポンスフレームを送信する。これにはAPの機能情報（セキュリティ設定やサポートするデータレートなど）が含まれる。

4. 認証: クライアントとAP間で認証フレームの交換を行い、クライアントがAPにアクセスする資格があることを確認する。この認証は通常、オープンシステム認証または共有鍵認証で行われる。

5. アソシエーション要求: 認証が成功すると、クライアントはAPに対してアソシエーション要求フレームを送信する。これにはクライアントのサポートする機能や設定情報が含まれる。

6. アソシエーション応答: APはクライアントに対してアソシエーション応答フレームを送信し、接続が承認されたことを通知する。この時点でクライアントはAPに正式に接続される。

7. 4-Way ハンドシェイク（セキュリティ設定）: WPA/WPA2/WPA3を使用する場合、認証と暗号鍵の確立のために4-Wayハンドシェイクが行われる。これにより、クライアントとAP間で暗号化キーが共有される。

##### WLCのインターフェース
- ディストリビューションポート: データトラフィックを処理するために使用されるWLCの主要なポート。スイッチや他のネットワーク機器に接続され、APとの通信を行うためのデータの受け渡しを行う。
- サービスポート: 主にメンテナンスと管理のために使用されるポート。WLCの設定やトラブルシューティングを行う際に使用され、通常はアウトオブバンド管理のために用いる。
- ダイナミックインターフェース: 各VLANごとに作成される論理的なインターフェース。複数のSSIDに対するトラフィックを分離するために使用され、特定のユーザグループに対して異なるネットワーク設定を提供できる。
- バーチャルインターフェース: WLCで使用される仮想的なインターフェースで、主にユーザのWeb認証（WebAuth）やDHCPリクエストを処理するために利用される。WLCとクライアント間で通信する際の仮想的なゲートウェイとして機能する。
- 管理インターフェース: WLCの管理トラフィック用のインターフェース。WLCの設定、監視、SNMPトラフィック、CAPWAPコントロールトラフィックなどに使用される。ネットワーク管理者がWLCにアクセスするための主要なインターフェース。
- サービスポートインターフェース: サービスポートに関連付けられたインターフェースで、主にWLCのメンテナンスや初期設定時に使用される。管理インターフェースとは異なり、一般的にアウトオブバンドで利用される。

##### Cisco Mobility Express
中小規模のネットワーク向けに設計されたWLC機能を持つAPソリューション。1台のAPがWLCとして機能し他のAPを管理する。専用のWLCを導入せずに、コストを抑えつつ無線ネットワークを簡単に構築できる。

##### FlexConnect
WAN回線を通じてリモートサイトにAPを配置する際に使用される技術。WANがダウンしても、APがローカルにスイッチングを行うことでネットワークサービスの継続を可能にする。リモートサイトでの接続性維持に有効。

試験で問われる用語として、"中央認証/中央スイッチング"(WLCを経由して通信)、"認証ダウン/ローカルスイッチング"(スタンドアロンモード)を押さえる。

##### WLANを用いたユーザプレゼンス分析(Cisco Connected Mobile Experiences)
WLANネットワークを利用してユーザの位置情報や滞在時間を分析する技術。APの信号強度や接続情報を基に施設内でのユーザの動きを追跡し、マーケティングやオペレーショナルインサイトの取得に利用される。これによりユーザの動線を把握し、店舗配置やサービス提供の最適化に役立てることが可能。

#### CAPWAP
（Control And Provisioning of Wireless Access Points）

WLCとAP間の通信をトンネリングするプロトコル。APはCAPWAPにより設定のプロビジョニングやファームウェアの更新をWLCから自動的に受け取る。これにより、大規模な環境でのAP管理が効率化される。CAPWAPはUDPベースで、コントロールトンネル(UDP5246番)とデータトンネル(UDP5247番)の2つのトンネルを使用する。CAPWAPトンネルにより、LAPとWLCの間にスイッチやルータがあっても影響を受けない。

以下、APがWLCを探索するプロセス

1. Discovery

APは起動後、WLCを探し出すための探索プロセスを開始する。DNS、DHCPオプション43、または静的IP設定によってWLCを見つける。探索メッセージをユニキャストまたはブロードキャスト(DHCPの場合)で送信し、応答を待つ。

2. Join

APが適切なWLCを見つけた後、JoinリクエストをWLCに送信し、WLCからのJoinレスポンスを待つ。このステップで、APはWLCに参加し、管理下に入ることになる。

3. mage Data

APのファームウェアがWLCと異なる場合、APはWLCから適切なイメージをダウンロードする。このプロセスにより、APとWLCが同じバージョンで動作し、互換性を保つことができる。

4. Config

 イメージの同期が完了した後、WLCはAPに対して必要な設定情報を送信する。これには、SSID、チャネル、パワーレベルなど、無線環境で必要とされる設定が含まれる。

5. Run

設定が完了すると、APはクライアント接続を処理し始め、運用状態に入る。この段階で、WLCはAPの動作を監視し、管理を行う。

6. Reset

必要に応じて、WLCはAPをリセットすることができる。リセット後、APは再びDiscoveryフェーズに戻り、WLCとの再接続を試みる。このリセットは、設定変更や障害復旧時に利用される。

以下は、APがWLCを選択する際のフロー（優先度）

1. LAPのNVRAMに保存されている設定情報を基にプライマリ -> セカンダリ -> ターシャリコントローラの順に「CAPWAP Join Request」を送信

過去にWLCに接続して設定したことがあるLAPが用いる情報。APが再起動した場合や、特定のコントローラへの接続を優先させたい場合に使用される。

2. 「Master Controllerフラグ」の情報を基にマスターコントローラに「CAPWAP Join Request」を送信

初めてWLCに接続するLAPが用いる情報。マスターコントローラは全体の管理を行う役割を持ち、新規APがどのコントローラに接続すべきかを決定する。

3. コントローラのAPキャパシティと現在のAP負荷の情報を基に、最もキャパシティに余裕のあるコントローラに「CAPWAP Join Request」を送信

ネットワーク全体の負荷分散を考慮し、最も効率的なコントローラに接続するための判断基準となる。これにより、各コントローラの負荷を均等化し、全体的なネットワークのパフォーマンスを最適化することが可能となる。

#### ローミング
現在接続しているAPから、別のAPへ設定を引き継いだままの移動を可能とする技術。

##### コントローラ内ローミング
同一WLC内でのAP間の移動。

##### コントローラ間ローミング
複数のWLC間でのローミング。ユーザが異なるWLC管理下のAPに移動してもセッションは継続される

##### サブネット間ローミング
異なるサブネット間での移動が必要な場合、アンカーコントローラや外部コントローラを用いて同じIPアドレスのまま通信を継続できる。

- アンカーコントローラ: 大元のコントローラ。ユーザが別のサブネットに移動しても元のコントローラがセッションを保持する役割。

- 外部コントローラ:ローミング先のコントローラ

##### モビリティグループ
複数のWLCをグループ化し、ローミング時にユーザのセッション情報を共有することでシームレスなローミングを実現。

##### IEEE802.11r(Fast Transition)
 ローミング時の認証処理を高速化するための規格。音声やビデオ通話などのリアルタイムアプリケーションで特に有効。

#### WLCの冗長化

##### SSO（stateful switchover）
主コントローラが故障した際に待機中の冗長コントローラが即座に引き継ぐ仕組み。ユーザセッションの中断を最小限に抑える。

##### モビリティMACアドレス
冗長構成において複数のWLCが一つのMACアドレスを共有し、ローミング時のシームレス性を向上させる。

#### 認証と暗号化

##### WPA2

- 暗号化方式: CCMP

- 暗号化アルゴリズム: AES（Advanced Encryption Standard）

- 認証方式: EAP（TLS, PEAP, TTLS）またはPSK（事前共有鍵）

##### WPA

- 暗号化方式: TKIP

- 暗号化アルゴリズム: RC4

- 認証方式: EAP（PEAP, TTLS）またはPSK

WPAはWPA2よりもセキュリティが低いため、徐々に利用は減少しているが、依然として互換性のために使用されることがある。

##### WEP

- 暗号化方式: WEP

- 暗号化アルゴリズム: RC4

- 認証方式: PSK（事前共有鍵）

セキュリティレベルは非常に低く、現代の無線LAN環境では推奨されていない。

認証方式の詳細:

- EAP（Extensible Authentication Protocol）: さまざまな認証方法をサポートするフレームワーク。主に企業ネットワークで使用される。

- TLS（Transport Layer Security）: 高いセキュリティを提供し、クライアント証明書とサーバ証明書の相互認証を使用。

- PEAP（Protected EAP）: TLSトンネル内でユーザー認証を行う方式。クライアント証明書が不要で、簡便さと安全性を両立。

- PSK（Pre-Shared Key）: 事前に共有された鍵を使用して認証を行う。個人向けネットワークで一般的。

#### WLC初期設定
デフォルトIPアドレスを用いてWEBコンソールに接続し、管理者用usernameとパスワードを設定する。
![画像1](https://raw.githubusercontent.com/220TI/Training-Reports/refs/heads/images/1119/1119_1.png)

PackettracerではローミングやVLANのアサインが出来なさそうなのでこれ以上の作業は断念。

### 問題解決の手法

#### ping
デフォルトでは、pingは送信元から宛先にICMPエコー要求を送信し、**2秒以内**に応答がある場合に成功と判断する。

#### 拡張ping

- 特権モードでのみ使用することができる
- 送信するエコー要求パケットの数を指定できる(repeat)
- 送信するエコー要求パケットのサイズを指定できる(size)
- タイムアウト値を指定できる(timeout)
- 分割を禁止にすることができる(df-bit)

これらの機能を用いることで、経路上の最小MTUを調べることができる。

1. df-bitを設定してpingを実行

df-bitをセットすることにより、パケットが途中で断片化されることを防ぐ。これにより、パケットが送信される途中でどこかのデバイスで断片化される場合、パケットはドロップされる。

2. パケットサイズを段階的に調整

パケットサイズを少しずつ減らしながらpingを実行し、成功する最大サイズを特定する。このサイズが経路上の最小MTUである。


#### traceroute

1. tracerouteは初めにTTLを1に設定し、宛先に向けてパケットを送信する。このパケットが最初のルーターに到達するとTTLが0になり、ルーターはパケットを破棄し、送信元にICMP Time Exceededメッセージを返す。このメッセージにより、送信元はパケットがどのルーターに到達したかを知ることができる。

2. 次にTTLを2に設定してパケットを再送信し、今度は2番目のルーターに到達するまで続ける。このプロセスを繰り返し、各ホップごとにICMP Time Exceededメッセージを受け取りながら、最終的に宛先に到達するまで経路を追跡する。

3. 宛先に到達したときには、これが使用されていないポートに送信されているため、Destination Unreachableメッセージを返すことで宛先への到達を確認することができる。

4. 実行結果の表示: tracerouteの実行結果には、各ホップごとの応答時間が表示される。各ホップに対して応答が得られない場合には、*（アスタリスク）が表示されることがあり、これは該当ルーターがICMP応答を拒否しているか、タイムアウトが発生したことを示す。

| 表示される文字 | 説明                                      |
|----------------|-----------------------------------------|
| *              | ICMP Time Exceededメッセージを受信できなかった |
| A              | アクセスリストなど管理上の理由により制御されている |
| H              | ホストに到達できなかった                     |
| P              | プロトコルが到達できなかった                   |
| N              | ネットワークが到達できなかった                 |

#### デバッグ
`#debug [デバッグ対象]` ⇒ `#show debugging`で実施可能だが、下記に留意しないとCPUに負荷が掛かる。

- 必要最低限のスコープで実行する: 不要な情報を出力しないように、目的に合った特定のデバッグコマンドのみを実行する。`#debug condition interface [interface]`で出力先のインターフェースの指定も可能。

- CPU使用率が低い状態であることを確認する: デバッグは大量のシステムリソースを消費するため、CPUの使用率が低い状態であることを確認する。高い負荷状態でデバッグを行うとデバイスがハングするリスクがある。

- コンソールポートにデバッグ情報が出力されないようにする: コンソールポートに大量のデバッグ情報が出力されると、デバイスの操作が困難になる。

#### loggingsynchronous

コマンドの入力中にメッセージが出力され入力が妨害されないよう、`(config-line)#logging synchronous`を設定する。

設定していなかった場合は、補完（Tab、?）を用いることで入力を続けることができる。Enterは押下しないこと。